/*
Copyright (c) 2011 Batiste Bieler and contributors,
https://github.com/batiste/sprite.js

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*//*jslint bitwise: true, undef: true, white: true, maxerr: 50, indent: 4 *//* Sprite.js v1.2.1
 *
 * coding guideline
 *
 * CamelCase everywhere (I don't like it but it seems to the standard these days).
 * Tabs have to be 4 spaces (python style).
 * If you contribute don't forget to add your name in the AUTHORS file.
 */(function(a){function r(a,b){return(a%b+b)%b}function s(a,b){return Math.sqrt(a*a+b*b)}function t(a,b,c){var d=s(a,b);return d===0?{x:a,y:b}:c?{x:a/d*c,y:b/d*c}:{x:a/d,y:b/d}}function u(a,b,c,d,e,f){var g=(c-a)*(f-b)-(d-b)*(e-a);return g===0?null:g>0}function v(a,b){var c=b.shift();while(c){if(typeof a[c]!="undefined")return c;c=b.shift()}}function w(){b.tproperty=v(l.body.style,["transform","WebkitTransform","MozTransform","OTransform","msTransform"]),b.animationFrame=v(a,["mozRequestAnimationFrame","webkitRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"]),b.createEventProperty=v(l,["createEvent","createEventObject"]),p=!0}function x(a,b,c,d){return a&&a[b]!==undefined?d==="int"?a[b]|0:a[b]:c}function y(a,b,c,d){var e=l.createElement("div"),f=e.style;return f.top=b+"px",f.left=a+"px",f.width=c+"px",f.height=d+"px",f.color="#fff",f.zIndex=100,f.position="absolute",f.backgroundColor="#000",f.opacity=.7,e}function i(a){return z||(z=new j(a)),z}function B(a){A||(A=l.createElement("textarea"),A.style.height="200px",A.style.width=window.innerWidth-100+"px",l.body.appendChild(A)),A.value=A.value+a,A.scrollTop=A.scrollHeight}function C(){if(!b.debug)return;var a="";for(var c=0;c<arguments.length;c++)a+=arguments[c]+" ";B(a+"\r\n")}"use strict";var b,c,d,e,f,g,h,i,j,k,l=a.document,m=0,n=0,o=0,p=!1,q=1;d=function D(c){if(this.constructor!==D)return new D(c);p||w(),this.autoPause=x(c,"autoPause",!0),this.main=x(c,"main",function(){});var d=l.createElement("div"),e;return d.style.overflow="hidden",d.style.imageRendering="-webkit-optimize-contrast",d.style.position="relative",d.className="sjs",d.id="sjs"+n,this.id=n,n+=1,e=x(c,"parent",l.body),e.appendChild(d),this.w=x(c,"w",480,"int"),this.h=x(c,"h",320,"int"),this.dom=d,this.dom.style.width=this.w+"px",this.dom.style.height=this.h+"px",this.layers={},this.ticker=null,this.useCanvas=x(c,"useCanvas",a.location.href.indexOf("canvas")!==-1),this.xscale=1,this.yscale=1,this.Layer("default"),b.scenes.push(this),this},d.prototype.constructor=d,d.prototype.Sprite=function(a,d){return d===undefined&&b.error("When you create Sprite from the scene the layer should be specified or false."),new c(this,a,d)},d.prototype.Layer=function(a,b){return new e(this,a,b)},d.prototype.Cycle=function(a){return new h(a)},d.prototype.Input=function(){return this.input=new i(this),this.input},d.prototype.scale=function(a,c){this.xscale=a,this.yscale=c,this.dom.style[b.tproperty+"Origin"]="0 0",this.dom.style[b.tproperty]="scale("+a+","+c+")"},d.prototype.toString=function(){return"Scene("+String(this.id)+")"},d.prototype.reset=function(){var a;this.ticker&&this.ticker.pause();for(a in this.layers)this.layers.hasOwnProperty(a)&&(this.layers[a].dom.parentNode.removeChild(this.layers[a].dom),delete this.layers[a]);while(this.dom.childNodes.length>=1)this.dom.removeChild(this.dom.firstChild);this.layers={},this.Layer("default")},d.prototype.Ticker=function(a,b){return this.ticker&&(this.ticker.pause(),this.ticker.paint=function(){}),this.ticker=new g(this,a,b),this.ticker},d.prototype.loadImages=function(a,c){c||(c=this.main);var d=0,e,f,g,h,i,j,k;for(k=0;k<a.length;k++)b.spriteCache[a[k]]||(d+=1,b.spriteCache[a[k]]={src:a[k],loaded:!1,loading:!1});if(d===0)return c();e=d,f=y(0,0,this.w,this.h),f.style.textAlign="center",f.style.paddingTop=this.h/2-16+"px",f.innerHTML="Loading",this.dom.appendChild(f),j=this,i=!1;var m=function(a){b.spriteCache[a].loading=!0,g=l.createElement("img"),b.spriteCache[a].img=g,g.addEventListener("load",function(){b.spriteCache[a].loaded=!0,d-=1,i===!1&&(d===0?(j.dom.removeChild(f),c()):f.innerHTML="Loading "+((e-d)/e*100|0)+"%")},!1),g.addEventListener("error",function(){i=!0,f.innerHTML="Error loading image "+a},!1),g.src=a};for(h in b.spriteCache)b.spriteCache.hasOwnProperty(h)&&(b.spriteCache[h].loading||m(h))},c=function(a,b,c){this.scene=a,this._dirty={},this.changed=!1,this.y=0,this.x=0,this._x_before=0,this._x_rounded=0,this._y_before=0,this._y_rounded=0,this.xv=0,this.yv=0,this.rv=0,this.type="rectangle",this.mass=1,this.friction=.05,this.xf=0,this.yf=0,this.src=null,this.img=null,this.imgNaturalWidth=null,this.imgNaturalHeight=null,this.w=null,this.h=null,this.xoffset=0,this.yoffset=0,this.dom=null,this.cycle=null,this.xscale=1,this.yscale=1,this.angle=0,this.xTransformOrigin=null,this.yTransformOrigin=null,this.backgroundRepeat=null,this.opacity=1,this.color=!1,this.id=++m,this.layer=null;var d,e,f,g,h,i,j;if(c)if(c.sprites)this.layer=c;else{j=c;for(i in j)j.hasOwnProperty(i)&&(d=j[i],e=this[i],typeof e=="function"?this[i].apply(this,d):e!==undefined&&(g=i.charAt(0),g!=="x"&&g!=="y"||i.length<=1?f="set"+g.toUpperCase()+i.slice(1):f="set"+g.toUpperCase()+i.charAt(1).toUpperCase()+i.slice(2),this[f]?this[f].apply(this,[d]):this[i]=d))}if(this.layer===undefined||c===undefined)this.layer=a.layers["default"];return this.layer&&!this.layer.useCanvas&&(h=l.createElement("div"),h.style.position="absolute",this.dom=h,this.layer.dom.appendChild(h)),b&&this.loadImg(b),this},c.prototype.constructor=c,c.prototype.setX=function(a){return this.x=a,this._x_rounded=a|0,this.changed=!0,this},c.prototype.setY=function(a){return this.y=a,this._y_rounded=a|0,this.changed=!0,this},c.prototype.setW=function(a){return this.w=a,this._dirty.w=!0,this.changed=!0,this},c.prototype.setH=function(a){return this.h=a,this._dirty.h=!0,this.changed=!0,this},c.prototype.setXOffset=function(a){return this.xoffset=a,this._dirty.xoffset=!0,this.changed=!0,this},c.prototype.setYOffset=function(a){return this.yoffset=a,this._dirty.yoffset=!0,this.changed=!0,this},c.prototype.setAngle=function(a){return this.angle=a,this._dirty.angle=!0,this.changed=!0,this},c.prototype.setColor=function(a){return this.color=a,this._dirty.color=!0,this.changed=!0,this},c.prototype.setOpacity=function(a){return this.opacity=a,this._dirty.opacity=!0,this.changed=!0,this},c.prototype.setXScale=function(a){return this.xscale=a,this._dirty.xscale=!0,this.changed=!0,this},c.prototype.setYScale=function(a){return this.yscale=a,this._dirty.yscale=!0,this.changed=!0,this},c.prototype.transformOrigin=function(a,b){return this.xTransformOrigin=a,this.yTransformOrigin=b,this._dirty.transform=!0,this.changed=!0,this},c.prototype.setBackgroundRepeat=function(a){return this._dirty.backgroundRepeat=!0,this.backgroundRepeat=a,this},c.prototype.rotate=function(a){return this.setAngle(this.angle+a),this},c.prototype.orient=function(a,b){var c=Math.atan2(b,a);this.setAngle(c)},c.prototype.scale=function(a,b){return this.xscale!==a&&this.setXScale(a),b===undefined&&(b=a),this.yscale!==b&&this.setYScale(b),this},c.prototype.move=function(a,b){return this.setX(this.x+a),this.setY(this.y+b),this},c.prototype.position=function(a,b){return this.setX(a),this.setY(b),this},c.prototype.offset=function(a,b){return this.setXOffset(a),this.setYOffset(b),this},c.prototype.size=function(a,b){return this.setW(a),this.setH(b),this},c.prototype.setForce=function(a,b){this.xf=a,this.yf=b},c.prototype.addForce=function(a,b){this.xf+=a,this.yf+=b},c.prototype.applyForce=function(a){a===undefined&&(a=1),this.xv-=this.friction*this.xv*this.mass*a,this.xv+=this.xf/this.mass*a,this.yv-=this.friction*this.yv*this.mass*a,this.yv+=this.yf/this.mass*a},c.prototype.velocity=function(){return s(this.xv,this.yv)},c.prototype.setVelocity=function(a,b){this.xv=a,this.yv=b},c.prototype.addVelocity=function(a,b){this.xv+=a,this.yv+=b},c.prototype.applyVelocity=function(a){return a===undefined&&(a=1),this.xv!==0&&this.setX(this.x+this.xv*a),this.yv!==0&&this.setY(this.y+this.yv*a),this.rv!==0&&this.setAngle(this.angle+this.rv*a),this},c.prototype.reverseVelocity=function(a){return a===undefined&&(a=1),this.xv!==0&&this.setX(this.x-this.xv*a),this.yv!==0&&this.setY(this.y-this.yv*a),this.rv!==0&&this.setAngle(this.angle-this.rv*a),this},c.prototype.applyXVelocity=function(a){a===undefined&&(a=1),this.xv!==0&&this.setX(this.x+this.xv*a)},c.prototype.reverseXVelocity=function(a){a===undefined&&(a=1),this.xv!==0&&this.setX(this.x-this.xv*a)},c.prototype.applyYVelocity=function(a){a===undefined&&(a=1),this.yv!==0&&this.setY(this.y+this.yv*a)},c.prototype.reverseYVelocity=function(a){a===undefined&&(a=1),this.yv!==0&&this.setY(this.y-this.yv*a)},c.prototype.rotateVelocity=function(a){var b=this.xv*Math.cos(a)-this.yv*Math.sin(a);this.yv=this.xv*Math.sin(a)+this.yv*Math.cos(a),this.xv=b},c.prototype.orientVelocity=function(a,b){var c=s(this.xv,this.yv),d;d=t(a,b,c),this.xv=d.x,this.yv=d.y},c.prototype.remove=function(){this.cycle&&this.cycle.removeSprite(this),this.layer&&!this.layer.useCanvas&&(this.layer.dom.removeChild(this.dom),this.dom=null),this.texture&&this.texture.remove(),this.texture=null,this.layer=null,this.img=null},c.prototype.webGLUpdate=function(){return this.texture||(this.texture=new webgl.Texture(this)),this.texture.render(this.x,this.y),this},c.prototype.update=function(){if(this.layer.useWebGL)return this.webGLUpdate();if(this.layer.useCanvas)return this.canvasUpdate();var a=this.dom.style,c;this._x_before!==this._x_rounded&&(a.left=(this.x|0)+"px"),this._y_before!==this._y_rounded&&(a.top=(this.y|0)+"px"),this._x_before=this._x_rounded,this._y_before=this._y_rounded;if(!this.changed)return this;this._dirty.w&&(a.width=(this.w|0)+"px"),this._dirty.h&&(a.height=(this.h|0)+"px");if(this._dirty.xoffset||this._dirty.yoffset)a.backgroundPosition=-(this.xoffset|0)+"px "+ -(this.yoffset|0)+"px";this._dirty.opacity&&(a.opacity=this.opacity),this._dirty.color&&(a.backgroundColor=this.color),this._dirty.transform&&(a[b.tproperty+"Origin"]=this.xTransformOrigin+" "+this.yTransformOrigin),this._dirty.backgroundRepeat&&(a.backgroundRepeat=this.backgroundRepeat);if(this._dirty.xscale||this._dirty.yscale||this._dirty.angle){c="",this.angle!==0&&(c+="rotate("+this.angle+"rad) ");if(this.xscale!==1||this.yscale!==1)c+=" scale("+this.xscale+", "+this.yscale+")";a[b.tproperty]=c}return this.changed=!1,this._dirty={},this},c.prototype.canvasUpdate=function(a){var b,c,d,e,f;a?b=a.ctx:b=this.layer.ctx,b.save(),this.xTransformOrigin===null?(c=this.w/2|0,d=this.h/2|0):(c=this.xTransformOrigin,d=this.yTransformOrigin),b.translate(this.x+c,this.y+d),b.rotate(this.angle),(this.xscale!==1||this.yscale!==1)&&b.scale(this.xscale,this.yscale),b.globalAlpha=this.opacity,b.translate(-c,-d),this.color&&(b.fillStyle=this.color,b.fillRect(0,0,this.w,this.h));if(this.imgLoaded&&this.img)if(this.imgNaturalWidth<this.w||this.imgNaturalHeight<this.h){e=Math.floor(this.w/this.imgNaturalWidth);while(e>0){e-=1,f=Math.floor(this.h/this.imgNaturalHeight);while(f>0)f-=1,b.drawImage(this.img,this.xoffset,this.yoffset,this.imgNaturalWidth,this.imgNaturalHeight,e*this.imgNaturalWidth,f*this.imgNaturalHeight,this.imgNaturalWidth,this.imgNaturalHeight)}}else b.drawImage(this.img,this.xoffset,this.yoffset,this.w,this.h,0,0,this.w,this.h);return b.restore(),this},c.prototype.toString=function(){return"Sprite("+String(this.id)+")"},c.prototype.onload=function(a){this.imgLoaded&&this._callback&&(this._callback=a)},c.prototype.loadImg=function(a,c){function g(d){f=e.img,b.spriteCache[a].loaded=!0,e.imgLoaded=!0,e.layer&&!e.layer.useCanvas&&(e.dom.style.backgroundImage="url("+a+")"),e.imgNaturalWidth=f.width,e.imgNaturalHeight=f.height,(e.w===null||c)&&e.setW(f.width),(e.h===null||c)&&e.setH(f.height),e.onload()}var d,e=this,f;return this.src=a,b.spriteCache[a]?(this.img=b.spriteCache[a].img,d=b.spriteCache[a].loaded):(this.img=l.createElement("img"),b.spriteCache[a]={src:a,img:this.img,loaded:!1,loading:!0},d=!1),d?g():(this.img.addEventListener("load",g,!1),this.img.src=a),this},c.prototype.distance=function(a,b){return typeof a=="number"?Math.sqrt(Math.pow(this.x+this.w/2-a,2)+Math.pow(this.y+this.h/2-b,2)):Math.sqrt(Math.pow(this.x+this.w/2-(a.x+a.w/2),2)+Math.pow(this.y+this.h/2-(a.y+a.h/2),2))},c.prototype.center=function(){return{x:this.x+this.w/2,y:this.y+this.h/2}},c.prototype.explode2=function(a,b,c){c||(c=this.layer),a===undefined&&(b?a=this.h/2:a=this.w/2),a|=0;var d=c.scene.Sprite(this.src,c),e=c.scene.Sprite(this.src,c);return b?(d.size(this.w,a),d.position(this.x,this.y),e.size(this.w,this.h-a),e.position(this.x,this.y+a),e.setYOffset(a)):(d.size(a,this.h),d.position(this.x,this.y),e.size(this.w-a,this.h),e.position(this.x+a,this.y),e.setXOffset(a)),[d,e]},c.prototype.explode4=function(a,b,c){a===undefined&&(a=this.w/2),b===undefined&&(b=this.h/2),a|=0,b|=0,c||(c=this.layer);var d=c.scene.Sprite(this.src,c),e=c.scene.Sprite(this.src,c),f=c.scene.Sprite(this.src,c),g=c.scene.Sprite(this.src,c);return d.size(a,b),d.position(this.x,this.y),e.size(this.w-a,b),e.position(this.x+a,this.y),e.offset(a,0),f.size(this.w-a,this.h-b),f.position(this.x+a,this.y+b),f.offset(a,b),g.size(a,this.h-b),g.position(this.x,this.y+b),g.offset(0,b),[d,e,f,g]},h=function bk(a){if(this.constructor!==bk)return new bk(a);var b,c;this.triplets=a,this.cycleDuration=0,this.changingTicks=[0];for(b=0;c=a[b];b++)this.cycleDuration=this.cycleDuration+c[2],this.changingTicks.push(this.cycleDuration);this.currentTripletIndex=undefined,this.sprites=[],this.repeat=!0,this.tick=0,this.done=!1,this.id=++o},h.prototype.addSprite=function(a){return this.sprites.push(a),a.cycle=this,this},h.prototype.toString=function(){return"Cycle("+String(this.id)+")"},h.prototype.update=function(){var a=this.sprites,b,c;for(b=0;c=a[b];b++)c.update();return this},h.prototype.addSprites=function(a){this.sprites=this.sprites.concat(a);var b,c;for(b=0;c=a[b];b++)c.cycle=this;return this},h.prototype.removeSprite=function(a){var b,c;for(b=0;c=this.sprites[b];b++)a==c&&(c.cycle=null,this.sprites.splice(b,1));return this},h.prototype.next=function(a,b){if(this.tick>this.cycleDuration)if(this.repeat)this.tick=0;else return this.done=!0,this;var c,d,e,f;for(d=0;d<this.changingTicks.length-1;d++)if(this.tick>=this.changingTicks[d]&&this.tick<=this.changingTicks[d+1]){c=d;break}if(c!==undefined&&c!==this.currentTickIndex){for(e=0;f=this.sprites[e];e++)f.setXOffset(this.triplets[d][0]),f.setYOffset(this.triplets[d][1]),b&&f.update();this.currentTripletIndex=c}return a=a||1,this.tick=this.tick+a,this},h.prototype.reset=function(a){var b,c;this.tick=0,this.done=!1;for(b=0;c=this.sprites[b];b++)c.setXOffset(this.triplets[0][0]),c.setYOffset(this.triplets[0][1]),a&&c.update();return this},h.prototype.go=function(a){var b,c;for(b=0;c=this.sprites[b];b++)c.setXOffset(this.triplets[a][0]),c.setYOffset(this.triplets[a][1]);return this},g=function br(a,c,d){if(typeof c=="number"){var e=c;c=d,d={tickDuration:e}}this.scene=a;if(this.constructor!==br)return new br(tickDuration,c);this.tickDuration=x(d,"tickDuration",16),this.useAnimationFrame=x(d,"useAnimationFrame",!1),b.animationFrame||(this.useAnimationFrame=!1),this.paint=c,this.start=(new Date).getTime(),this.now=this.start,this.ticksElapsed=0,this.currentTick=0,this.ticksSinceLastStart=0,this.droppedFrames=0},g.prototype.next=function(){var a=(new Date).getTime();return this.diff=a-this.now,this.now=a,this.lastTicksElapsed=Math.round(this.diff/this.tickDuration),this.droppedFrames+=Math.max(0,this.lastTicksElapsed-1),this.ticksSinceLastStart+=this.lastTicksElapsed,this.currentTick+=this.lastTicksElapsed,this.lastTicksElapsed},g.prototype.run=function(){if(this.paused)return;var c=this,d=this.next();if(d==0){setTimeout(function(){c.run()},this.tickDuration);return}for(var e in this.scene.layers){var f=this.scene.layers[e];f.useCanvas&&f.autoClear&&f.clear()}this.paint(this),this.scene.input&&this.scene.input.next(),this.timeToPaint=(new Date).getTime()-this.now,this.load=(this.timeToPaint/this.tickDuration*100+this.load)/2|0,this.fps=Math.round(1e3/(this.now-(this.lastPaintAt||0))),this.lastPaintAt=this.now;if(this.useAnimationFrame)this.tickDuration=16,a[b.animationFrame](function(){c.run()});else{var g=Math.max(this.tickDuration-this.timeToPaint,6);this.timeout=setTimeout(function(){c.run()},g)}},g.prototype.pause=function(){a.clearTimeout(this.timeout),a[b.animationFrame]=undefined,this.paused=!0},g.prototype.resume=function(){this.start=(new Date).getTime(),this.ticksElapsed=0,this.ticksSinceLastStart=0,this.paused=!1,this.run()};var z=!1;j=function(c){function e(a,b){if(!d.enableCustomEvents)return;if(l.createEvent){var c=l.createEvent("Events");c.initEvent("sjs"+a,!0,!0),c.value=b,d.dom.dispatchEvent(c)}else if(l.createEventObject){var c=l.createEventObject();c.value=b,d.dom.fireEvent("onsjs"+a,c)}}function f(a,b){e(a,b),(a=="space"||a=="enter")&&f("action",b),d.keyboard[a]!==b&&(d.keyboard[a]=b,d.keyboardChange[a]=b)}function g(a,b){(a.keyCode==40||a.keyCode==83)&&f("down",b),(a.keyCode==38||a.keyCode==87)&&f("up",b),(a.keyCode==39||a.keyCode==68)&&f("right",b),(a.keyCode==37||a.keyCode==65)&&f("left",b),a.keyCode==32&&f("space",b),a.keyCode==17&&f("ctrl",b),a.keyCode==13&&f("enter",b),a.keyCode==27&&f("esc",b);if(a.keyCode>=48&&a.keyCode<=90){var c=String.fromCharCode(a.keyCode);f(c.toLowerCase(),b)}}function i(a){d.mouse.click={x:(a.clientX-d.dom.offsetLeft)/c.xscale,y:(a.clientY-d.dom.offsetTop)/c.yscale}}function j(a){d.mousedown=!0,d.mouse.down=!0,d.mousepressed=!0,a.preventDefault()}function k(a){d.mousedown=!1,d.mouse.down=!1,d.mousereleased=!0,d.mouse.click={x:(a.clientX-d.dom.offsetLeft)/c.xscale,y:(a.clientY-d.dom.offsetTop)/c.yscale}}function m(a){d.mouse.position={x:(a.clientX-d.dom.offsetLeft)/c.xscale,y:(a.clientY-d.dom.offsetTop)/c.yscale}}function n(a){return a.touches&&a.touches.length?a=a.touches[0]:a.changedTouches&&a.changedTouches.length&&(a=a.changedTouches[0]),a}c?this.dom=c.dom:this.dom=l.body;var d=this;this.keyboard={},this.mouse={position:{},click:undefined},this.keyboardChange={},this.mousedown=!1,d.mousepressed=!1,this.mousereleased=!1,this.keydown=!1,this.touchMoveSensibility=3,this.enableCustomEvents=!1,this.touchable="ontouchstart"in a,this.next=function(){d.disableFor&&(d.disableFor=d.disableFor-1),d.keyboardChange={},d.mousepressed=!1,d.mouse.click=undefined,d.mousereleased=!1},this.disableFor=0,this.disable=function(a){d.disableFor=a},this.keyPressed=function(a){return d.keyboardChange[a]!==undefined&&d.keyboardChange[a]},this.keyReleased=function(a){return d.keyboardChange[a]!==undefined&&!d.keyboardChange[a]};var h=function(b,c){a.addEventListener(b,c,!1)};this.touchable&&(h("touchstart",function(a){a=n(a),f("space",!0),i(a),d.touchStart={x:a.clientX,y:a.clientY}}),h("touchend",function(a){k(a),d.keyboard={},d.touchStart=null}),h("touchmove",function(a){a.preventDefault(),a=n(a),f("space",!1),m(a);if(d.touchStart){var b=a.clientX-d.touchStart.x,c=a.clientY-d.touchStart.y;c<-d.touchMoveSensibility&&(f("up",!0),f("down",!1)),c>d.touchMoveSensibility&&(f("down",!0),f("up",!1)),b<-d.touchMoveSensibility&&(f("left",!0),f("right",!1)),b>d.touchMoveSensibility&&(f("right",!0),f("left",!1)),d.touchStart.x+=b/10,d.touchStart.y+=c/10}}),h("touchmove",function(a){a=n(a),m(a)})),h("mousedown",j),h("mouseup",k),h("click",i),h("mousemove",m),h("keydown",function(a){d.keydown=!0,g(a,!0)}),h("keyup",function(a){d.keydown=!1,g(a,!1)}),h("keypress",function(a){}),b.debug||h("contextmenu",function(a){a.preventDefault()})},j.prototype.arrows=function(){return this.keyboard.right||this.keyboard.left||this.keyboard.up||this.keyboard.down},a.addEventListener("blur",function(a){for(var c=0;c<b.scenes.length;c++){var d=b.scenes[c];if(!d.autoPause)continue;var e=function(a){z.keyboard={},z.keydown=!1,z.mousedown=!1;if(a.ticker&&!a.ticker.paused){a.ticker.pause();var b=y(0,0,a.w,a.h);b.innerHTML="<h1>Paused</h1><p>Click or press any key to resume.</p>",b.style.textAlign="center",b.style.paddingTop=a.h/2-32+"px";var c=function(d){d.stopPropagation(),d.preventDefault(),a.dom.removeChild(b),l.removeEventListener("click",c,!1),l.removeEventListener("keyup",c,!1),a.ticker.resume()};l.addEventListener("click",c,!1),l.addEventListener("keyup",c,!1),a.dom.appendChild(b)}};e(d)}},!1),e=function bu(a,c,d){var e,f,g,h;if(!this||this.constructor!==bu)return new bu(a,c,d);this.sprites={},this.scene=a,d===undefined&&(d={useCanvas:a.useCanvas,autoClear:!0}),d.useWebGL&&(d.useCanvas=!0),d.autoClear===undefined?this.autoClear=!0:this.autoClear=d.autoClear,d.useCanvas===undefined?this.useCanvas=this.scene.useCanvas:this.useCanvas=d.useCanvas,this.useWebGL=d.useWebGL,this.name=c;if(this.scene.layers[c]===undefined)this.scene.layers[c]=this;else return b.debug&&b.warning("A layer named "+c+" already exist."),this.scene.layers[c];e=l.getElementById(c),e?f=!1:f=!0,this.useCanvas?(e&&e.nodeName.toLowerCase()!=="canvas"&&b.error("Cannot use HTMLElement "+e.nodeName+" with canvas renderer."),f&&(e=l.createElement("canvas"))):f&&(e=l.createElement("div")),f?(g=!1,h=!1):(g=e.height||e.style.height,h=e.width||e.style.width),d.parent?this.parent=d.parent:this.parent=this.scene.dom,this.parent.appendChild(e),e.id=e.id||"sjs"+a.id+"-"+c,d.disableAutoZIndex||(q+=1,e.style.zIndex=String(q)),e.style.backgroundColor=d.color||e.style.backgroundColor,this.h=d.h||g||a.h,this.w=d.w||h||a.w,e.nodeName=="CANVAS"?(e.height=this.h,e.width=this.w):(e.style.height=this.h+"px",e.style.width=this.w+"px"),e.style.position="absolute",e.style.top=e.style.top||"0px",e.style.left=e.style.left||"0px",this.dom=e,this.useCanvas&&(d.useWebGL?this.ctx=webgl.init(e):this.ctx=e.getContext("2d"))},e.prototype.constructor=e,e.prototype.clear=function(){this.useWebGL?this.ctx.clear(this.ctx.COLOR_BUFFER_BIT|this.ctx.DEPTH_BUFFER_BIT):this.ctx.clearRect(0,0,this.dom.width,this.dom.height)},e.prototype.Sprite=function(a,b){return b?b.layer=this:b=this,new c(this.scene,a,b)},e.prototype.remove=function(){this.parent.removeChild(this.dom),delete this.scene.layers[this.name]},e.prototype.addSprite=function(a){var b=Math.random()*11;return this.sprites[b]=a,b},e.prototype.setColor=function(a){this.dom.style.backgroundColor=a},e.prototype.onTop=function(a){q+=1,this.dom.style.zIndex=String(q)},k=function bA(a){if(this.constructor!==bA)return new bA(a);this.list=a||[],this.length=this.list.length,this.index=-1},k.prototype.add=function(a){a.length?this.list.push.apply(this.list,a):this.list.push(a),this.length=this.list.length},k.prototype.remove=function(a){for(var b=0,c;c=this.list[b];b++)if(c==a)return this.list.splice(b,1),this.index>-1&&(this.index=this.index-1),this.length=this.list.length,!0},k.prototype.iterate=function(){return this.index+=1,this.index<this.list.length?this.list[this.index]:(this.index=-1,!1)};var A=null,b={spriteCache:{},debug:!1,Cycle:h,Input:i,Scene:d,SpriteList:k,List:k,Sprite:c,overlay:y,scenes:[],error:function(a){C("Error: "+a)},warning:function(a){C("Warning: "+a)},log:C,createEvent:null,math:{hypo:s,mod:r,normalVector:t,lineSide:u}};a.sjs=b})(this)